section .data
    ; Секция данных с инициализированными переменными
    prompt1 db "Enter 1 number: ", 0          ; Приглашение для первого числа
    prompt1_len equ $ - prompt1               ; Автоматический расчет длины строки prompt1
    
    prompt2 db "Enter 2 number: ", 0          ; Приглашение для второго числа  
    prompt2_len equ $ - prompt2               ; Автоматический расчет длины строки prompt2
    
    result db "Sum: ", 0                      ; Сообщение для вывода результата
    result_len equ $ - result                 ; Автоматический расчет длины строки result
    
    newline db 10                             ; Символ новой строки (ASCII 10 = '\n')

section .bss
    ; Секция неинициализированных данных езервирование памяти)
    buffer1 resb 16      ; Буфер для ввода первого числа (16 байт)
    buffer2 resb 16      ; Буфер для ввода второго числа (16 байт)
    num1 resq 1          ; Переменная для хранения первого числа (8 байт)
    num2 resq 1          ; Переменная для хранения второго числа (8 байт)
    sum resq 1           ; Переменная для хранения суммы (8 байт)
    output resb 32       ; Буфер для вывода результата как строки (32 байта)

section .text
    global _start        ; Объявление точки входа программы

_start:
    ; === ВВОД ПЕРВОГО ЧИСЛА ===
    mov rax, 1               ; Номер системного вызова: 1 = sys_write (запись)
    mov rdi, 1               ; Файловый дескриптор: 1 = stdout (стандартный вывод)
    mov rsi, prompt1         ; Указатель на строку для вывода
    mov rdx, prompt1_len     ; Длина выводимой строки
    syscall                  ; Вызов системного вызова - вывод приглашения

    ; СБРОС БУФЕРА ВЫВОДА (вывод символа новой строки)
    mov rax, 1               ; sys_write
    mov rdi, 1               ; stdout
    mov rsi, newline         ; Указатель на символ новой строки
    mov rdx, 1               ; Длина: 1 символ
    syscall                  ; Вызов системного вызова - вывод новой строки

    ; ЧТЕНИЕ ПЕРВОГО ЧИСЛА С КЛАВИАТУРЫ
    mov rax, 0               ; Номер системного вызова: 0 = sys_read (чтение)
    mov rdi, 0               ; Файловый дескриптор: 0 = stdin (стандартный ввод)
    mov rsi, buffer1         ; Указатель на буфер для ввода данных
    mov rdx, 16              ; Максимальное количество байт для чтения
    syscall                  ; Вызов системного вызова - чтение ввода пользователя

    ; === КОНВЕРТАЦИЯ ПЕРВОГО ЧИСЛА ИЗ СТРОКИ В ЧИСЛО ===
    mov rsi, buffer1         ; Передача указателя на строку в RSI (аргумент функции)
    call string_to_int       ; Вызов функции преобразования строки в число
    mov [num1], rax          ; Сохранение результата в переменную num1

    ; === ВВОД ВТОРОГО ЧИСЛА ===
    mov rax, 1               ; sys_write
    mov rdi, 1               ; stdout
    mov rsi, prompt2         ; Приглашение для второго числа
    mov rdx, prompt2_len     ; Длина приглашения
    syscall                  ; Вывод приглашения

    ; СБРОС БУФЕРА ВЫВОДА
    mov rax, 1               ; sys_write
    mov rdi, 1               ; stdout
    mov rsi, newline         ; Символ новой строки
    mov rdx, 1               ; Длина: 1 символ
    syscall                  ; Вывод новой строки

    mov rax, 0               ; sys_read
    mov rdi, 0               ; stdin
    mov rsi, buffer2         ; Буфер для второго числа
    mov rdx, 16              ; Максимальная длина ввода
    syscall                  ; Чтение второго числа

    ; === КОНВЕРТАЦИЯ ВТОРОГО ЧИСЛА ИЗ СТРОКИ В ЧИСЛО ===
    mov rsi, buffer2         ; Указатель на строку второго числа
    call string_to_int       ; Преобразование строки в число
    mov [num2], rax          ; Сохранение результата в num2

    ; === СЛОЖЕНИЕ ЧИСЕЛ ===
    mov rax, [num1]          ; Загрузка первого числа в RAX
    add rax, [num2]          ; Сложение с вторым числом
    mov [sum], rax           ; Сохранение результата в переменную sum

    ; === ВЫВОД РЕЗУЛЬТАТА ===
    mov rax, 1               ; sys_write
    mov rdi, 1
; stdout
    mov rsi, result          ; Сообщение "Sum: "
    mov rdx, result_len      ; Длина сообщения
    syscall                  ; Вывод сообщения "Sum: "

    ; ПРЕОБРАЗОВАНИЕ СУММЫ ИЗ ЧИСЛА В СТРОКУ
    mov rax, [sum]           ; Загрузка суммы в RAX
    mov rdi, output          ; Указатель на буфер для результата
    call int_to_string       ; Вызов функции преобразования числа в строку

    ; ВЫВОД РЕЗУЛЬТАТА (СУММЫ)
    mov rax, 1               ; sys_write
    mov rdi, 1               ; stdout
    mov rsi, output          ; Буфер с преобразованной строкой
    mov rdx, rbx             ; Длина строки (возвращается функцией int_to_string в RBX)
    syscall                  ; Вывод суммы

    ; ФИНАЛЬНЫЙ ПЕРЕВОД СТРОКИ
    mov rax, 1               ; sys_write
    mov rdi, 1               ; stdout
    mov rsi, newline         ; Символ новой строки
    mov rdx, 1               ; Длина: 1 символ
    syscall                  ; Вывод новой строки

    ; === ЗАВЕРШЕНИЕ ПРОГРАММЫ ===
    mov rax, 60              ; Номер системного вызова: 60 = sys_exit (завершение)
    xor rdi, rdi             ; Код возврата: 0 (успешное завершение)
    syscall                  ; Завершение программы

; === ФУНКЦИИ ===

; Функция преобразования строки в число
; Вход: RSI = указатель на строку
; Выход: RAX = преобразованное число
string_to_int:
    xor rax, rax             ; Обнуление RAX (здесь будет накапливаться результат)
    xor rcx, rcx             ; Обнуление RCX (используется как индекс/счетчик)
convert_loop:
    movzx rdx, byte [rsi + rcx]  ; Загрузка текущего символа с нулевым расширением
    cmp rdx, 10              ; Проверка на символ новой строки (конец ввода)
    je done                  ; Если символ новой строки - завершение
    cmp rdx, 0               ; Проверка на нулевой символ (конец строки)
    je done                  ; Если нулевой символ - завершение
    sub rdx, '0'             ; Преобразование ASCII символа в цифру (вычитаем '0')
    imul rax, 10             ; Умножение текущего результата на 10 (сдвиг разрядов)
    add rax, rdx             ; Добавление текущей цифры к результату
    inc rcx                  ; Переход к следующему символу
    jmp convert_loop         ; Повтор цикла
done:
    ret                      ; Возврат из функции

; Функция преобразования числа в строку
; Вход: RAX = число для преобразования, RDI = указатель на буфер для строки
; Выход: RBX = длина результирующей строки
int_to_string:
    mov rbx, 10              ; Основание системы счисления (10 для десятичной)
    mov rcx, 0               ; Обнуление счетчика цифр
    test rax, rax            ; Проверка числа на ноль
    jnz convert_loop2        ; Если не ноль, переходим к обычному преобразованию
    
    ; ОБРАБОТКА СЛУЧАЯ КОГДА ЧИСЛО РАВНО НУЛЮ
    mov byte [rdi], '0'      ; Записываем символ '0' в буфер
    mov rbx, 1               ; Устанавливаем длину строки = 1
    ret                      ; Возврат из функции

convert_loop2:
    xor rdx, rdx             ; Обнуление RDX для операции деления
    div rbx                  ; Деление RAX на 10: RAX = частное, RDX = остаток
    add dl, '0'              ; Преобразование цифры в ASCII символ
    push rdx                 ; Сохранение цифры в стеке (в обратном порядке)
    inc rcx                  ; Увеличение счетчика цифр
    test rax, rax            ; Проверка, не стало ли частное нулем
    jnz convert_loop2        ; Если не ноль, продолжаем цикл
    
    ; ПЕРЕВОРАЧИВАЕМ ЦИФРЫ ИЗ СТЕКА В ПРАВИЛЬНОМ ПОРЯДКЕ
    mov rbx, rcx             ; Сохраняем количество цифр в RBX (длина строки)
reverse_loop2:
    pop rdx                  ; Извлекаем цифру из стека (в правильном порядке)
    mov [rdi], dl            ; Записываем символ в буфер
    inc rdi                  ; Переходим к следующей позиции в буфере
    loop reverse_loop2       ; Повторяем для всех цифр
    
    mov byte [rdi], 0        ; Добавляем нулевой символ в конец строки
    ret                      ; Возврат из функции
